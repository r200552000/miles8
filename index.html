<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>å“©ç¨‹æ”»ç•¥ v8.2 (å°ˆæ¥­ç²¾ç®—ç‰ˆ)</title>

  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&family=Mali:wght@500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* =========================
       CSS æ¨£å¼è¡¨ (å»¶çºŒ v8.1 å¯æ„›é¢¨æ ¼)
       ========================= */
    :root {
      --bg-main: #fffdf9;
      --bg-card: #ffffff;
      --primary: #60a5fa;
      --primary-dark: #2563eb;
      --text-header: #334155;
      --text-body: #475569;
      --text-light: #94a3b8;
      --shadow-draw: 3px 3px 0px rgba(0,0,0,0.06);
      --radius-box: 24px;
      --radius-pill: 50px;
      --font-hand: 'Mali', cursive;
      --font-main: 'Varela Round', sans-serif;
    }

    body {
      background-color: var(--bg-main);
      color: var(--text-body);
      font-family: var(--font-main);
      padding-bottom: 120px;
      min-height: 100vh;
      background-image: radial-gradient(#e0f2fe 2px, transparent 2px);
      background-size: 24px 24px;
      -webkit-tap-highlight-color: transparent;
    }

    h1,h2,h3,h4,h5,h6 { font-family: var(--font-hand); font-weight: 700; color: var(--text-header); }

    /* Header */
    .header {
      background: #ffffff; padding: 15px 20px 25px 20px;
      border-bottom-left-radius: 36px; border-bottom-right-radius: 36px;
      position: sticky; top: 0; z-index: 1000;
      box-shadow: var(--shadow-draw); margin-bottom: -10px;
      display: flex; justify-content: space-between; align-items: center;
      height: 100px; border-bottom: 3px dashed #bae6fd;
    }
    .header-icon {
      width: 44px; height: 44px; background: #eff6ff; border: 2px solid #bfdbfe;
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      color: var(--primary); font-size: 1.2rem; transform: rotate(-5deg); margin-right: 12px;
    }
    .header-title h5 { margin: 0; font-size: 1.4rem; color: var(--primary-dark); }
    .header-title small { color: var(--text-light); font-size: 0.8rem; font-family: var(--font-hand); }

    .btn-header {
      background: #fff; border: 2px solid #e2e8f0; color: var(--text-body);
      font-weight: 700; font-family: var(--font-hand); font-size: 0.9rem;
      padding: 8px 14px; box-shadow: 2px 2px 0 #e2e8f0; border-radius: 20px;
      transition: 0.1s;
    }
    .btn-header:active { transform: translateY(2px); box-shadow: 0 0 0; }

    .container-custom { padding: 20px 16px; max-width: 600px; margin: 0 auto; position: relative; z-index: 101; }
    
    .card-box {
      background: var(--bg-card);
      border-radius: var(--radius-box);
      padding: 20px; margin-bottom: 16px;
      border: 2px solid #f1f5f9;
      box-shadow: var(--shadow-draw);
    }

    .form-label {
      font-weight: 700; color: var(--text-header);
      margin-bottom: 6px; font-size: 0.9rem; font-family: var(--font-hand);
    }
    .form-control, .form-select {
      background-color: #fff !important; border: 2px solid #cbd5e1 !important;
      color: var(--text-header) !important;
      padding: 10px 14px; border-radius: 16px;
      font-size: 1rem; font-weight: 600; height: 48px;
      box-shadow: inset 2px 2px 4px rgba(0,0,0,0.03);
    }
    .form-control:focus, .form-select:focus {
      border-color: var(--primary) !important;
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2) !important;
    }
    
    #amount { color: var(--primary) !important; font-size: 1.5rem; letter-spacing: 1px; font-family: var(--font-hand); }
    
    /* Buttons */
    .btn-action {
      background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
      color: white; font-weight: 700; border-radius: var(--radius-pill);
      padding: 14px; width: 100%; border: none; font-size: 1.1rem;
      font-family: var(--font-hand);
      box-shadow: 3px 3px 0 rgba(59, 130, 246, 0.25);
      margin-top: 10px; border: 2px solid #bfdbfe;
      transition: 0.1s;
    }
    .btn-action:active { transform: translateY(3px); box-shadow: 0 0 0; }

    /* Switch Groups */
    .switch-group {
      background: #f8fafc; padding: 10px 14px; border-radius: 16px;
      border: 2px solid #e2e8f0; box-shadow: 2px 2px 0 #e2e8f0;
      display: flex; align-items: center; justify-content: space-between;
      height: 100%; white-space: nowrap; cursor: pointer;
    }
    .switch-label {
      font-size: 0.85rem; font-weight: 700; color: var(--text-body);
      font-family: var(--font-hand); margin-right: 4px; display: flex; align-items: center; gap: 6px;
    }
    .form-check-input {
      width: 2.8em; height: 1.5em;
      background-color: #cbd5e1; border: 2px solid #cbd5e1;
      cursor: pointer; transition: 0.3s; flex-shrink: 0;
    }
    .form-check-input:checked { background-color: var(--primary); border-color: var(--primary); }

    /* Result Cards */
    #result-area { display: none; animation: popUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
    @keyframes popUp { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

    .result-tag {
      background: var(--primary); color: white;
      padding: 4px 16px; border-radius: 20px; font-size: 0.85rem;
      font-weight: 700; display: inline-block; font-family: var(--font-hand);
      box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
      transform: rotate(-1deg);
    }

    .plan-card {
      padding: 16px; border-radius: 18px; margin-top: 12px;
      border: 2px solid #f1f5f9; position: relative; background: #fff;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.03);
    }
    .plan-winner { 
      border-color: var(--primary); background: #f0f9ff; 
      transform: rotate(-0.5deg);
    }
    .winner-badge {
      position: absolute; top: -12px; right: 10px;
      background: #fde047; color: var(--text-header);
      font-size: 0.75rem; padding: 4px 12px; border-radius: 14px;
      font-weight: 700; border: 2px solid #fde047;
      box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
      transform: rotate(3deg); font-family: var(--font-hand);
    }
    .card-name { font-size: 1.1rem; font-weight: 800; color: var(--text-header); margin: 0; }
    .card-miles { font-size: 1.3rem; color: #34d399; font-weight: 900; font-family: var(--font-hand); }
    .card-tpm { font-size: 0.75rem; color: #94a3b8; font-weight: 700; background: #fff; padding: 2px 8px; border-radius: 10px; display: inline-block; border: 1px solid #e2e8f0; }
    .benefit-tag { font-size:0.75rem; color:#fff; background:#64748b; padding:2px 6px; border-radius:4px; margin-left:6px; vertical-align:middle; }

    /* Bottom Nav */
    .nav-bottom {
      position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
      width: 280px; background: #ffffff; border: 3px solid #bfdbfe;
      border-radius: 50px; display: flex; justify-content: space-evenly;
      padding: 8px; z-index: 2000; box-shadow: 4px 4px 0 rgba(191, 219, 254, 0.5);
    }
    .nav-item {
      color: var(--text-light); font-size: 0.85rem; font-weight: 700;
      cursor: pointer; padding: 8px 24px; transition: 0.2s;
      display: flex; align-items: center; gap: 6px; font-family: var(--font-hand);
      border-radius: 30px;
    }
    .nav-item.active { background: #eff6ff; color: var(--primary); }

    /* Settings Modal */
    .modal-content { 
      border-radius: 24px; border: 3px solid #bfdbfe; background: #fffdf7; 
    }
    .modal-header { border-bottom: 2px dashed #e2e8f0; padding: 20px; }
    .modal-title { font-weight: 800; color: var(--text-header); font-family: var(--font-hand); }
    
    .setting-section { 
      background: #fff; padding: 16px; border-radius: 18px; margin-bottom: 16px; 
      border: 2px solid #f1f5f9; box-shadow: 2px 2px 0 #f1f5f9;
    }
    .setting-title { 
      font-size: 0.9rem; font-weight: 700; color: var(--text-header); 
      margin-bottom: 12px; font-family: var(--font-hand); display: flex; align-items: center; gap:6px;
    }
    .setting-title::before { content:''; display:inline-block; width:4px; height:16px; background:var(--primary); border-radius:4px; }

    .custom-card-item {
      background: #f8fafc; padding: 12px; border-radius: 14px; margin-bottom: 10px;
      display: flex; justify-content: space-between; align-items: center;
      border: 2px solid #e2e8f0;
    }
    .delete-btn { 
      color: #ef4444; background: #fff; width: 36px; height: 36px; border-radius: 10px; 
      display: flex; align-items: center; justify-content: center; cursor: pointer; 
      border: 2px solid #fecaca; box-shadow: 2px 2px 0 #fecaca;
    }
    
  </style>
</head>

<body>
  <div class="header">
    <div class="d-flex align-items-center">
      <div class="header-icon"><i class="fa-solid fa-plane-departure"></i></div>
      <div class="header-title">
        <h5>å“©ç¨‹æ”»ç•¥ v8.2</h5>
        <small>å°ˆæ¥­ç²¾ç®—ç‰ˆ (2026è¦å‰‡)</small>
      </div>
    </div>
    <button class="btn-header" onclick="openSettings()"><i class="fa-solid fa-gear me-1"></i> è¨­å®š</button>
  </div>

  <div class="container-custom">
    <div id="page-calc" class="page-section">
      <div class="card-box">
        <div class="row g-2 mb-3">
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('birthdayMode')" style="background:#fff1f2; border-color:#fecdd3; box-shadow: 2px 2px 0 #fecdd3;">
              <span class="switch-label text-danger"><i class="fa-solid fa-cake-candles"></i> ç”Ÿæ—¥æœˆ</span>
              <input class="form-check-input" type="checkbox" id="birthdayMode">
            </div>
          </div>
          <div class="col-6">
            <div class="switch-group" onclick="toggleSwitch('flyMode')" style="background:#ecfdf5; border-color:#a7f3d0; box-shadow: 2px 2px 0 #a7f3d0;">
              <span class="switch-label text-success"><i class="fa-solid fa-ticket"></i> è¶Šé£›æœ‰å“©</span>
              <input class="form-check-input" type="checkbox" id="flyMode">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é‡‘é¡</label>
          <div class="input-group">
            <input type="number" id="amount" class="form-control" placeholder="0" inputmode="decimal">
          </div>
        </div>

        <div class="row g-2 mb-3">
          <div class="col-6">
            <label class="form-label">å¹£åˆ¥</label>
            <select id="currency" class="form-select">
              <option value="TWD">ğŸ‡¹ğŸ‡¼ TWD</option>
              <option value="JPY">ğŸ‡¯ğŸ‡µ JPY</option>
              <option value="USD">ğŸ‡ºğŸ‡¸ USD</option>
              <option value="EUR">ğŸ‡ªğŸ‡º EUR</option>
              <option value="KRW">ğŸ‡°ğŸ‡· KRW</option>
              <option value="THB">ğŸ‡¹ğŸ‡­ THB</option>
              <option value="CNY">ğŸ‡¨ğŸ‡³ CNY</option>
              <option value="SGD">ğŸ‡¸ğŸ‡¬ SGD</option>
              <option value="other">ğŸŒ å…¶ä»–</option>
            </select>
          </div>
          <div class="col-6">
            <label class="form-label">æ”¯ä»˜æ–¹å¼</label>
            <select id="payment" class="form-select">
              <option value="physical">ğŸ’³ å¯¦é«”å¡</option>
              <option value="online">ğŸŒ ç·šä¸Š/ç¶²è³¼</option>
              <option value="apple_pay">ğŸ Apple Pay</option>
              <option value="line_pay">ğŸŸ© LINE Pay</option>
            </select>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">æ¶ˆè²»é¡åˆ¥ / å‚™è¨»</label>
          <select id="category" class="form-select mb-2" onchange="updateKeywordPlaceholder()">
            <option value="general">ğŸ›ï¸ ä¸€èˆ¬æ¶ˆè²»</option>
            <option value="dining">ğŸ½ï¸ é¤å»³/å¤–é€</option>
            <option value="travel">ğŸ¨ æ—…éŠ/è¨‚æˆ¿</option>
            <option value="flight_ci">ğŸŒ¸ è¯èˆªå®˜ç¶²</option>
            <option value="flight_cx">ğŸŒ² åœ‹æ³°å®˜ç¶²</option>
            <option value="flight_other">âœˆï¸ å…¶ä»–èˆªç©º</option>
          </select>
          <input type="text" id="keyword-input" class="form-control" placeholder="è¼¸å…¥åº—å®¶é—œéµå­— (å¦‚: Agoda, Uniqlo)..." style="font-size:0.9rem;">
        </div>

        <button onclick="calculate()" class="btn-action">é–‹å§‹è¨ˆç®— <i class="fa-solid fa-calculator ms-2"></i></button>
      </div>

      <div id="result-area">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
          <span class="result-tag" id="scenario-tag">ä¸€èˆ¬æ¶ˆè²»</span>
          <span class="small fw-bold text-muted bg-white px-2 py-1 rounded border border-dashed" id="fx-info" style="display:none;"></span>
        </div>

        <div id="cards-container">
          </div>

        <div class="card-box mt-3 p-3 text-center" style="background:#f8fafc; border-style:dashed;">
           <button onclick="recordResult()" class="btn btn-outline-dark rounded-pill fw-bold px-4 w-100" style="font-family:var(--font-hand); border-width:2px;">
             <i class="fa-solid fa-check me-2"></i> è¨˜å¸³é€™ç­† (é¦–é¸)
           </button>
        </div>
      </div>
    </div>

    <div id="page-status" class="page-section" style="display:none;">
      <div class="card-box">
        <h5 class="mb-3 text-primary"><i class="fa-solid fa-chart-pie me-2"></i>æœ¬æœŸç´¯ç©</h5>
        <div id="status-container"></div>
        <div class="mt-3 d-flex gap-2">
           <button onclick="clearCurrentStats()" class="btn btn-sm btn-outline-danger flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">é‡ç½®æœ¬æœŸ</button>
           <button onclick="exportData()" class="btn btn-sm btn-outline-primary flex-grow-1 rounded-pill fw-bold" style="border-width:2px; font-family:var(--font-hand);">åŒ¯å‡º JSON</button>
        </div>
      </div>
      
      <div class="card-box mt-3" style="background:#fffbeb; border-color:#fde68a;">
        <h5 class="mb-3 text-warning" style="color:#b45309;"><i class="fa-solid fa-shield-halved me-2"></i>ä¸Šé™å°ç®¡å®¶</h5>
        <div id="limits-container"></div>
        <small class="text-muted d-block mt-2 text-center font-hand">ä¸Šé™æœƒæ ¹æ“šè¨­å®šçš„çµå¸³æ—¥è‡ªå‹•é‡ç½®</small>
      </div>
    </div>
  </div>

  <div class="nav-bottom">
    <div class="nav-item active" onclick="switchPage('calc')">
      <i class="fa-solid fa-calculator"></i> è¨ˆç®—
    </div>
    <div class="nav-item" onclick="switchPage('status')">
      <i class="fa-solid fa-chart-simple"></i> ç›£æ§
    </div>
  </div>

  <div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">âš™ï¸ è¨­å®šèˆ‡å¡ç‰‡ç®¡ç†</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          
          <div class="setting-section">
            <div class="setting-title">å…§å»ºç¥å¡ (è¤‡é›œé‚è¼¯)</div>
            <div id="builtin-cards-list">
              </div>
          </div>

          <div class="setting-section">
            <div class="setting-title">è‡ªè¨‚å¡ç‰‡ (ç°¡æ˜“é‚è¼¯)</div>
            <div id="custom-cards-list" class="mb-3"></div>
            
            <div class="bg-white p-3 rounded-3 border border-2 border-primary-subtle" style="border-style:dashed;">
              <label class="small fw-bold text-primary mb-2 font-hand">ï¼‹ æ–°å¢å¡ç‰‡</label>
              <input type="text" id="new-card-name" class="form-control mb-2" placeholder="å¡ç‰‡åç¨± (å¦‚: é•·æ¦®æ¥µè‡´)">
              <div class="row g-2">
                <div class="col-6">
                  <input type="number" id="new-card-dom" class="form-control" placeholder="åœ‹å…§(å…ƒ/å“©)">
                </div>
                <div class="col-6">
                  <input type="number" id="new-card-for" class="form-control" placeholder="åœ‹å¤–(å…ƒ/å“©)">
                </div>
              </div>
              <button onclick="addCustomCard()" class="btn btn-sm btn-primary w-100 mt-2 rounded-pill fw-bold font-hand">ç¢ºèªæ–°å¢</button>
            </div>
          </div>

          <div class="setting-section">
            <div class="setting-title">å¸³å–®çµå¸³æ—¥ (æ¯æœˆå¹¾è™Ÿ)</div>
            <div id="billing-days-list">
              </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* =========================
       å“©ç¨‹æ”»ç•¥ v8.2 - å°ˆæ¥­ç²¾ç®—ç‰ˆ (2026è¦å‰‡)
       ========================= */

    const BUILTIN_DEFS = [
      { id: 'hsbc_live', name: 'åŒ¯è± Live+', default: true, note: 'é¤é£²è³¼ç‰©ç¥å¡' },
      { id: 'cube',      name: 'åœ‹æ³° CUBE',  default: true, note: 'ä¸–ç•Œå¡ 300é»=1000å“©' },
      { id: 'dbs_garena',name: 'æ˜Ÿå±• å‚³èªªå°æ±º',default: true, note: 'LinePay 10%' },
      { id: 'ctbc_ci',   name: 'ä¸­ä¿¡ è¯èˆªé¼å°Š',default: true, note: 'ç”Ÿæ—¥æœˆ $6/å“©' },
      { id: 'taishin_cx',name: 'å°æ–° åœ‹æ³°ä¸–ç•Œ',default: true, note: 'è¶Šé£›æœ‰å“© $5/å“©' },
      { id: 'hsbc_inf',  name: 'åŒ¯è± æ—…äººç„¡é™',default: true, note: 'åœ‹å¤– $10/å“©' }
    ];

    const DEFAULT_BILLING = { hsbc:6, cube:18, dbs:4, ctbc:15, taishin:20, other:1 };
    const RATES = { TWD:1, USD:33.5, JPY:0.225, EUR:36, CNY:4.6, KRW:0.025, THB:0.96, SGD:24.5 };
    
    // CUBE æ¬Šç›Šé—œéµå­—åº«
    const CUBE_KEYWORDS = {
      'travel': ['travel','agoda','booking','hotels','airbnb','klook','kkday','é›„ç…','å¯æ¨‚','flight','èˆªç©º','æ©Ÿç¥¨','æµ·å¤–','foreign'],
      'dining': ['dining','é¤å»³','åƒé£¯','é¼æ³°è±','å£½å¸','ç«é‹','ç‡’è‚‰','ç‰›æ’','æ˜Ÿå·´å…‹','ubereats','foodpanda'],
      'digital': ['online','momo','pchome','shopee','è¦çš®','coupang','amazon','åšå®¢ä¾†','steam','netflix','spotify','disney','app store','google play'],
      'select': ['carrefour','å…¨è¯','ä¸­æ²¹','å°äº','é«˜éµ','uber']
    };

    // Live+ é—œéµå­—
    const LIVE_KEYWORDS = {
      'dining': ['é¤å»³','åƒé£¯','é¼æ³°è±','è—å£½å¸','å£½å¸','ç«é‹','ç‡’è‚‰','ç‰›æ’','å±…é…’å±‹','æ˜Ÿå·´å…‹','è·¯æ˜“è','å¤–é€','ubereats','foodpanda'],
      'shop': ['uniqlo','zara','ç„¡å°','h&m','net','gu','nike','adidas','outlet','ç™¾è²¨','sogo','æ–°å…‰','é æ±']
    };

    // --- ç‹€æ…‹ç®¡ç† ---
    const DB_KEY = 'MILES_APP_V8_DATA';
    function loadDB() {
      const raw = localStorage.getItem(DB_KEY);
      if(!raw) return initDB();
      return JSON.parse(raw);
    }
    function saveDB(data) { localStorage.setItem(DB_KEY, JSON.stringify(data)); }
    function initDB() {
      return {
        settings: {
          enabledBuiltins: BUILTIN_DEFS.map(c => c.id),
          billingDays: { ...DEFAULT_BILLING }
        },
        customCards: [], records: {}, limits: {}
      };
    }

    // --- è¨ˆç®—æ ¸å¿ƒ (v8.2 ä¿®æ­£ç‰ˆ) ---

    function calculate() {
      const db = loadDB();
      const amt = parseFloat($('amount').value);
      if(!amt) return alert('è«‹è¼¸å…¥é‡‘é¡');
      
      const curr = $('currency').value;
      const isForeign = curr !== 'TWD';
      const rate = RATES[curr] || 1;
      const twdBase = Math.round(amt * rate);
      const twdSpend = isForeign ? Math.round(twdBase * 1.015) : twdBase; 

      const cat = $('category').value;
      const pay = $('payment').value;
      const kw = ($('keyword-input').value || '').toLowerCase();
      const isBirthday = $('birthdayMode').checked;
      const isFlyMode = $('flyMode').checked;
      
      let tags = [];
      if(isForeign) tags.push('åœ‹å¤–');
      if(pay === 'line_pay') tags.push('LinePay');

      // é—œéµå­—æª¢æ¸¬
      let cubePlan = 'unknown';
      let isLiveSelect = false;

      // CUBE æ¬Šç›Šåˆ¤æ–·
      if(isForeign || cat==='travel' || cat.startsWith('flight')) cubePlan = 'travel';
      else {
        for(let p in CUBE_KEYWORDS) {
          if(CUBE_KEYWORDS[p].some(w => kw.includes(w))) { cubePlan = p; break; }
        }
        if(cubePlan==='unknown') {
          if(cat==='dining') cubePlan = 'dining';
        }
      }

      // Live+ åˆ¤æ–·
      if(cat==='dining') isLiveSelect = true;
      else {
        if(LIVE_KEYWORDS['dining'].some(w => kw.includes(w)) || LIVE_KEYWORDS['shop'].some(w => kw.includes(w))) {
          isLiveSelect = true;
        }
      }

      $('fx-info').style.display = isForeign ? 'inline-block' : 'none';
      $('fx-info').innerText = `ç´„ NT$${twdSpend}`;
      $('scenario-tag').innerText = tags.length ? tags.join(' + ') : 'ä¸€èˆ¬æ¶ˆè²»';

      let results = [];

      // 1. åœ‹æ³° CUBE (ä¸–ç•Œå¡ 300é»=1000å“©)
      if(db.settings.enabledBuiltins.includes('cube')) {
        let pRate = 0.003; 
        let planName = 'ä¸€èˆ¬æ¶ˆè²»(0.3%)';
        
        // æ¬Šç›Šåç¨±å°ç…§
        const planMap = { 
          'travel': 'è¶£æ—…è¡Œ', 'dining': 'æ¨‚é¥—è³¼', 'digital': 'ç©æ•¸ä½', 'select': 'é›†ç²¾é¸' 
        };

        if(cubePlan !== 'unknown' && planMap[cubePlan]) {
          pRate = 0.03;
          planName = `åˆ‡æ›è‡³ã€${planMap[cubePlan]}ã€‘(3%)`;
        } else if(isForeign) { // æ²’é—œéµå­—ä½†åœ‹å¤–
           pRate = 0.03; planName = `åˆ‡æ›è‡³ã€è¶£æ—…è¡Œã€‘(3%)`;
        }

        const rawPoints = Math.floor(twdBase * pRate);
        // ä¸–ç•Œå¡æ¯”ä¾‹ä¿®æ­£: 300é» = 1000å“© (ç´„ 3.33å€)
        const finalMiles = Math.floor(rawPoints * (1000 / 300)); 
        
        results.push({ 
          id:'cube', name:'åœ‹æ³° CUBE', 
          miles: finalMiles, 
          note: `${planName}<br><span class="text-muted small">ä¸–ç•Œå¡ 300é»â‡„1000å“©</span>`, 
          type:'mile' 
        });
      }

      // 2. åŒ¯è± Live+ (1é»=2å“©)
      if(db.settings.enabledBuiltins.includes('hsbc_live')) {
        let pRate = 0.0088; // ä¸€èˆ¬ 0.88%
        let note = 'ä¸€èˆ¬ 0.88%';
        
        if(isLiveSelect) {
          pRate = 0.0388; note = 'ç²¾é¸ 3.88%';
          if(isForeign) { // é€™è£¡å‡è¨­ç²¾é¸åœ‹å¤–ä¸ç–ŠåŠ ï¼Œä¾ Live+ æ¢æ¬¾é€šå¸¸ç²¾é¸å„ªå…ˆ
             // è‹¥æœ‰ç¶å®šè‡ªå‹•æ‰£ç¹³+1% -> 4.88% (é€™è£¡ç°¡åŒ–ä»¥ 3.88/4.88 ç‚ºä¸»)
             pRate = 0.0488; note = 'ç²¾é¸+åŠ ç¢¼ 4.88%';
          }
        }
        
        const cashPoints = Math.floor(twdBase * pRate);
        const finalMiles = cashPoints * 2; // ä¿®æ­£æ¯”ä¾‹: 1é»æ›2å“©

        results.push({ 
          id:'hsbc_live', name:'åŒ¯è± Live+', 
          miles: finalMiles, 
          note: `${note} <br><span class="text-muted small">1é»ç¾é‡‘ç©é»â‡„2å“©</span>`, 
          type:'mile' 
        });
      }

      // 3. æ˜Ÿå±• å‚³èªªå°æ±º (LinePay 10%)
      if(db.settings.enabledBuiltins.includes('dbs_garena')) {
        let pRate = 0.01; // åœ‹å…§ä¸€èˆ¬ 1% (100å…ƒ1é») => 1é»=2å“© => 2å“©/100å…ƒ = 50å…ƒ/å“©
        let note = 'ä¸€èˆ¬1% (ç´„50å…ƒ/å“©)';
        
        if(pay === 'line_pay') {
          pRate = 0.1; // 10%
          note = 'LinePay 10% (ç´„5å…ƒ/å“©)';
        }
        
        // ä¿®æ­£: 1é» = 1å…ƒç¾é‡‘ç©é»
        const pts = Math.floor(twdBase * pRate);
        // ä¿®æ­£å…Œæ›: 50é» = 100å“© (é•·æ¦®/äºè¬) => 1é» = 2å“©
        const finalMiles = pts * 2;
        
        results.push({ 
          id:'dbs_garena', name:'æ˜Ÿå±• å‚³èªª', 
          miles: finalMiles, 
          note: `${note}`, 
          type:'mile' 
        });
      }

      // 4. ä¸­ä¿¡ è¯èˆªé¼å°Š (ç”Ÿæ—¥æœˆä¸Šé™)
      if(db.settings.enabledBuiltins.includes('ctbc_ci')) {
        let div = 18;
        if(isForeign || cat === 'flight_ci') div = 9;
        
        let note = `ç´„${div}å…ƒ/å“©`;
        
        if(isBirthday && (isForeign || cat === 'flight_ci')) {
          div = 6;
          note = `ç”Ÿæ—¥æœˆ $6/å“© <span class="text-danger small">(åˆ·40è¬ä¸Šé™)</span>`;
        }
        
        results.push({ 
          id:'ctbc_ci', name:'ä¸­ä¿¡ è¯èˆª', 
          miles: Math.floor(twdSpend/div), 
          note: note, 
          type:'mile' 
        });
      }

      // 5. å°æ–° åœ‹æ³°ä¸–ç•Œ (è¶Šé£›æœ‰å“©)
      if(db.settings.enabledBuiltins.includes('taishin_cx')) {
        let div = isForeign ? 10 : 20; // åŸºæœ¬: åœ‹å¤–10/åœ‹å…§20 (ç°¡åŒ–) -> å¯¦éš›ä¸Šè¶Šé£›æœ‰å“©æ˜¯æµ·å¤–å¯¦é«”
        let note = `ç´„${div}å…ƒ/å“©`;

        // è¶Šé£›æœ‰å“©: æµ·å¤–å¯¦é«” / æŒ‡å®šæ—…éŠ $5/å“©
        // éœ€åˆ¤æ–·æ˜¯å¦ç¬¦åˆé¡åˆ¥
        const isTarget = (isForeign && pay==='physical') || cat==='travel' || ['agoda','booking','klook','kkday'].some(w=>kw.includes(w));
        
        if(isFlyMode && isTarget) {
          div = 5;
          note = `è¶Šé£›æœ‰å“© $5/å“© <span class="text-danger small">(å¹´ä¸Šé™20è¬å“©)</span>`;
        }

        results.push({ 
          id:'taishin_cx', name:'å°æ–° åœ‹æ³°', 
          miles: Math.floor(twdSpend/div), 
          note: note, 
          type:'mile' 
        });
      }

      // 6. åŒ¯è± æ—…äºº (åœ‹å¤–10)
      if(db.settings.enabledBuiltins.includes('hsbc_inf')) {
        let div = isForeign ? 10 : 18;
        if(cat.startsWith('flight')) div = 10;
        results.push({ id:'hsbc_inf', name:'åŒ¯è± æ—…äºº', miles: Math.floor(twdSpend/div), note: `ç´„${div}å…ƒ/å“©`, type:'mile' });
      }

      // è‡ªè¨‚å¡ç‰‡
      db.customCards.forEach(c => {
        let div = isForeign ? c.forRate : c.domRate;
        if(!div || div <= 0) div = 999;
        results.push({ 
          id: c.id, name: c.name, 
          miles: Math.floor(twdSpend / div), 
          note: `è¨­å®š${div}å…ƒ/å“©`, 
          type: 'custom' 
        });
      });

      // æ’åº: é‡Œç¨‹é«˜è€…å„ªå…ˆ
      // (v8.2 å…¨éƒ¨éƒ½å·²ç¶“çµ±ä¸€è½‰æˆ "Mile" å–®ä½äº†ï¼Œç›´æ¥æ¯”å¤§å°)
      results.forEach(r => {
        r.tpm = r.miles > 0 ? (twdSpend / r.miles) : 999;
      });
      results.sort((a,b) => b.miles - a.miles);
      
      window.currentBest = { ...results[0], twdSpend, twdBase };
      renderResults(results, twdSpend);
    }

    // --- æ¸²æŸ“èˆ‡è¼”åŠ©åŠŸèƒ½ (ç¶­æŒ v8.1) ---

    function renderResults(list, spend) {
      const con = $('cards-container');
      con.innerHTML = '';
      $('result-area').style.display = 'block';

      if(list.length === 0) {
        con.innerHTML = '<div class="text-center p-3 text-muted">æ²’æœ‰å•Ÿç”¨çš„å¡ç‰‡</div>';
        return;
      }

      list.forEach((c, idx) => {
        const isWinner = idx === 0;
        const div = document.createElement('div');
        div.className = `plan-card ${isWinner ? 'plan-winner' : ''}`;
        let badge = isWinner ? `<span class="winner-badge"><i class="fa-solid fa-crown"></i> WINNER</span>` : '';
        
        div.innerHTML = `
          ${badge}
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h4 class="card-name">${c.name}</h4>
              <div class="text-muted small mt-1 font-hand">${c.note}</div>
            </div>
            <div class="text-end">
              <div class="card-miles">${c.miles} <small style="font-size:0.5em; color:#64748b;">å“©</small></div>
              <div class="card-tpm">${c.tpm < 100 ? c.tpm.toFixed(1) : '>100'} å…ƒ/å“©</div>
            </div>
          </div>
        `;
        con.appendChild(div);
      });
    }

    // è¨˜å¸³ã€ä¸Šé™ã€è¨­å®šåŠŸèƒ½ (ä¿æŒä¸è®Š)
    function getBillingCycle(cardPrefix, billingDay) {
      const now = new Date();
      const today = now.getDate();
      const monthOffset = (today > billingDay) ? 1 : 0;
      const d = new Date(now.getFullYear(), now.getMonth() + monthOffset, 1);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    }

    function recordResult() {
      if(!window.currentBest) return;
      const { id, name, miles, twdSpend, twdBase } = window.currentBest;
      if(!confirm(`ç¢ºå®šè¨˜å¸³ï¼Ÿ\nå¡ç‰‡ï¼š${name}\nç´¯ç©ï¼š${miles} å“©`)) return;

      const db = loadDB();
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      
      if(!db.records[monthKey]) db.records[monthKey] = {};
      if(!db.records[monthKey][id]) db.records[monthKey][id] = { miles:0, spend:0, name };
      db.records[monthKey][id].miles += miles;
      db.records[monthKey][id].spend += twdSpend;

      let day = db.settings.billingDays[id.split('_')[0]] || db.settings.billingDays['other'] || 1;
      const cycleKey = getBillingCycle(null, day); 
      const limitKey = `${cycleKey}-${id}`;
      if(!db.limits[limitKey]) db.limits[limitKey] = { spend:0, points:0, startDay: day };
      db.limits[limitKey].spend += twdBase; 
      db.limits[limitKey].points += miles;

      saveDB(db);
      alert('âœ… å·²è¨˜å¸³ï¼');
      updateStatusUI();
    }

    function updateStatusUI() {
      const db = loadDB();
      const now = new Date();
      const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      
      const statusCon = $('status-container');
      const monthData = db.records[monthKey] || {};
      let html = '';
      if(Object.keys(monthData).length === 0) {
        html = '<div class="text-center py-3 text-muted">æœ¬æœˆå°šç„¡ç´€éŒ„</div>';
      } else {
        html = '<ul class="list-group list-group-flush">';
        for(let id in monthData) {
          html += `<li class="list-group-item d-flex justify-content-between align-items-center bg-transparent px-0 border-bottom border-dashed">
            <span class="fw-bold text-secondary">${monthData[id].name}</span>
            <span class="fw-bold text-primary" style="font-family:var(--font-hand);">+${monthData[id].miles}</span>
          </li>`;
        }
        html += '</ul>';
      }
      statusCon.innerHTML = html;

      const limitsCon = $('limits-container');
      let limitHtml = '';
      const targets = [
        { id: 'hsbc_live', name: 'åŒ¯è± Live+', limit: 29600, type:'spend' }, 
        { id: 'dbs_garena', name: 'æ˜Ÿå±• å‚³èªª', limit: 1000, type:'point' } // é€™è£¡é‚„æ˜¯ç›£æ§åŸå§‹é»æ•¸æ¦‚å¿µæ¯”è¼ƒæº–ï¼Œä½†ç‚ºç°¡åŒ–å…ˆé¡¯ç¤ºç´¯ç©
      ];

      targets.forEach(t => {
        const prefix = t.id.split('_')[0];
        const day = db.settings.billingDays[prefix] || 1;
        const cycleKey = getBillingCycle(null, day);
        const dataKey = `${cycleKey}-${t.id}`;
        const record = db.limits[dataKey] || { spend:0, points:0 };
        
        // å‚³èªªå°æ±ºä¸Šé™æ˜¯çœ‹é»æ•¸ï¼ŒLive+çœ‹åˆ·å¡é¡
        const current = t.type === 'spend' ? record.spend : Math.floor(record.points / 2); // å‚³èªªçš„å›æ¨åŸå§‹é»æ•¸
        const percent = Math.min(100, Math.round((current / t.limit) * 100));
        
        let color = 'bg-success';
        if(percent > 80) color = 'bg-warning';
        if(percent >= 100) color = 'bg-danger';

        limitHtml += `
          <div class="mb-3">
            <div class="d-flex justify-content-between small mb-1">
              <strong>${t.name}</strong>
              <span>${current.toLocaleString()} / ${t.limit.toLocaleString()} (${percent}%)</span>
            </div>
            <div class="progress" style="height: 8px; border-radius:4px; background:#e2e8f0;">
              <div class="progress-bar ${color}" style="width: ${percent}%; border-radius:4px;"></div>
            </div>
            <div class="text-end text-muted mt-1" style="font-size:0.7rem; font-family:var(--font-hand);">çµå¸³æ—¥: æ¯æœˆ${day}è™Ÿ (æœ¬æœŸ: ${cycleKey})</div>
          </div>
        `;
      });
      limitsCon.innerHTML = limitHtml || '<div class="text-center small text-muted">ç„¡é ˆç›£æ§çš„å¡ç‰‡</div>';
    }

    function openSettings() { renderSettings(); new bootstrap.Modal($('settingsModal')).show(); }
    
    function renderSettings() {
      const db = loadDB();
      const builtinCon = $('builtin-cards-list');
      builtinCon.innerHTML = '';
      BUILTIN_DEFS.forEach(def => {
        const isOn = db.settings.enabledBuiltins.includes(def.id);
        builtinCon.innerHTML += `
          <div class="switch-group mb-2">
            <span class="switch-label">${def.name} <span class="text-muted small fw-normal ms-2">(${def.note})</span></span>
            <input class="form-check-input" type="checkbox" ${isOn?'checked':''} onchange="toggleBuiltin('${def.id}')">
          </div>
        `;
      });
      const customCon = $('custom-cards-list');
      customCon.innerHTML = '';
      if(db.customCards.length === 0) customCon.innerHTML = '<div class="text-muted small text-center mb-2">å°šç„¡è‡ªè¨‚å¡ç‰‡</div>';
      db.customCards.forEach((c, idx) => {
        customCon.innerHTML += `
          <div class="custom-card-item">
            <div>
              <div class="fw-bold">${c.name}</div>
              <div class="small text-muted font-hand">åœ‹å…§ ${c.domRate} / åœ‹å¤– ${c.forRate}</div>
            </div>
            <div class="delete-btn" onclick="delCustomCard(${idx})"><i class="fa-solid fa-trash"></i></div>
          </div>
        `;
      });
      const billCon = $('billing-days-list');
      billCon.innerHTML = '';
      const banks = { hsbc:'åŒ¯è±', cube:'åœ‹æ³°', dbs:'æ˜Ÿå±•', ctbc:'ä¸­ä¿¡', taishin:'å°æ–°', other:'å…¶ä»–' };
      for(let key in banks) {
        const day = db.settings.billingDays[key] || 1;
        billCon.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-2 bg-white p-2 rounded border" style="border:2px solid #e2e8f0 !important;">
            <span class="fw-bold text-secondary font-hand">${banks[key]}</span>
            <input type="number" class="form-control form-control-sm w-25 text-center" value="${day}" onchange="updateBilling('${key}', this.value)">
          </div>
        `;
      }
    }

    function toggleBuiltin(id) {
      const db = loadDB();
      const idx = db.settings.enabledBuiltins.indexOf(id);
      if(idx >= 0) db.settings.enabledBuiltins.splice(idx, 1);
      else db.settings.enabledBuiltins.push(id);
      saveDB(db);
    }
    function addCustomCard() {
      const name = $('new-card-name').value;
      const dom = parseFloat($('new-card-dom').value);
      const fore = parseFloat($('new-card-for').value);
      if(!name || !dom || !fore) return alert('è«‹å¡«å¯«å®Œæ•´');
      const db = loadDB();
      db.customCards.push({ id: `cust_${Date.now()}`, name, domRate: dom, forRate: fore });
      saveDB(db);
      renderSettings();
      $('new-card-name').value = ''; $('new-card-dom').value = ''; $('new-card-for').value = '';
    }
    function delCustomCard(idx) {
      if(!confirm('åˆªé™¤æ­¤å¡ï¼Ÿ')) return;
      const db = loadDB();
      db.customCards.splice(idx, 1);
      saveDB(db);
      renderSettings();
    }
    function updateBilling(key, val) {
      const db = loadDB();
      db.settings.billingDays[key] = parseInt(val) || 1;
      saveDB(db);
    }
    function $(id) { return document.getElementById(id); }
    function toggleSwitch(id) { /* UI */ }
    function switchPage(p) {
      document.querySelectorAll('.page-section').forEach(e => e.style.display='none');
      $(`page-${p}`).style.display='block';
      document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
      event.currentTarget.classList.add('active');
      if(p==='status') updateStatusUI();
      window.scrollTo(0,0);
    }
    function clearCurrentStats() {
       if(!confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) return;
       const db = loadDB();
       const now = new Date();
       const monthKey = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
       db.records[monthKey] = {};
       saveDB(db);
       updateStatusUI();
    }
    function exportData() {
       const db = loadDB();
       const blob = new Blob([JSON.stringify(db,null,2)], {type : 'application/json'});
       const a = document.createElement('a');
       a.href = URL.createObjectURL(blob);
       a.download = 'miles_backup_v8_2.json';
       a.click();
    }
    window.onload = function() { updateStatusUI(); };
  </script>
</body>
</html>
